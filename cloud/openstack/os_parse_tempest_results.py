#!/usr/bin/python

from ansible.module_utils.basic import *
import os

DOCUMENTATION = '''
---
module: os_parse_tempest_results
short_description: this module parse the result file generated by Tempest (OpenStack)
description:
    - Parse Tempest's results to the format the user chose using subunit

author: "Tal Shafir , @TalShafir"
requirements:
    - testr or os-testr installed
options:
    results_path:
        description:
            -path to the results file Tempest generated
        required: True
    output_path:
        description:
            -path to the parsed results file this module will generated
        required: False
        default: I(results_path)
    output_format:
        description:
            -format of the parsed results file this module will generated
        required: False
        default: xml
        choices: [xml, html]

'''
EXAMPLES = ''' # TODO
'''


def main():
    module = AnsibleModule(argument_spec={
        "results_path": {"type": "path", "required": True},
        "output_path": {"type": "path", "required": False},
        "output_format": {"type": "string", "required": False, "default": "html", "choices": ["xml", "html"]}
    })

    # activate_virtual_environment() TODO
    if module.params['output_format'] == 'html':  # TODO handle directory instead of file as the output_path
        import os_testr.subunit2html
        _argv = sys.argv  # save original argv
        sys.argv = [sys.argv[0], module.params['results_path'],
                    module.params['output_path']]  # change argv to work with subunit2html
        os_testr.subunit2html.main()
        sys.argv = _argv  # restore the argv to the original
        module.exit_json(msg="html file was successfully created", output_path=module.params['output_path'])

    elif module.params['output_format'] == 'xml':
        pass  # TODO


def activate_virtual_environment(environment_path):
    """
        Activate the python virtual environment in the given path
        :param environment_path: A path to the python virtual environment
        :type environment_path: str
        """
    activation_script_suffix = '/bin/activate_this.py'
    activate_venv = environment_path + activation_script_suffix
    execfile(activate_venv, dict(__file__=activate_venv))


if __name__ == '__main__':
    main()
